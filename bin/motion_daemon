#!/env/bin/python
# Based off the tutorial by adafruit here:
# http://learn.adafruit.com/adafruits-raspberry-pi-lesson-11-ds18b20-temperature-sensing/software

import os
import RPi.GPIO as GPIO
import time
import utils

abspath = os.path.abspath(__file__)
dname = os.path.dirname(abspath)


def get_motion():
    GPIO.setwarnings(False)
    GPIO.setmode(GPIO.BOARD)
    GPIO.setup(11, GPIO.IN)  # Read output from PIR motion sensor

    return bool(GPIO.input(11))


def main(sleep_time):
    failures = 0
    old_motion = True

    attributes = {'friendly_name': 'Living Room Motion'}
    while True:
        try:

            new_motion = get_motion()

            if new_motion != old_motion:
                utils.send_to_ha('binary_sensor.living_room_motion',
                                 new_motion,
                                 attributes)
        except:
            failures += 1

            if failures > 10:
                pass
                utils.restart()

            time.sleep(60)

            continue

        old_motion = new_motion
        failures = 0
        time.sleep(sleep_time)

if __name__ == "__main__":
   main(1)

